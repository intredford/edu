# База данных: аптека

## Таблицы

Диаграмма:

![](https://file.dimius.ru/edu/db/schema.png)

### drugs

Таблица лекарств

| Поле               | Тип       | Описание            |
| ------------------ | --------- | ------------------- |
| id                 | `INT`     |                     |
| name               | `VARCHAR` | Название лекарства  |
| price              | `DECIMAL` | Цена за штуку       |
| needs_perscription | `BOOLEAN` | Требуется ли рецепт |
| stock              | `INT`     | Сколько в наличии   |

### employees

Таблица сотрудников

| Поле     | Тип       | Описание              |
| -------- | --------- | --------------------- |
| id       | `INT`     |                       |
| name     | `VARCHAR` | Имя сотрудника        |
| hired_at | `DATE`    | Дата приема на работу |
| fired_at | `DATE`    | Дата увольнения       |

### customers

Таблица клиентов

| Поле          | Тип       | Описание               |
| ------------- | --------- | ---------------------- |
| id            | `INT`     |                        |
| name          | `VARCHAR` | Имя клиента            |
| phone         | `VARCHAR` | Номер телефона         |
| date_of_birth | `DATE`    | Дата рождения          |


### customer_prescriptions

Таблица рецептов клиентов

| Поле        | Тип    | Описание                              | Ссылается на   |
| ----------- | ------ | ------------------------------------- | -------------- |
| id          | `INT`  |                                       |                |
| customer_id | `INT`  | Айди клиента                          | `customers.id` |
| drug_id     | `INT`  | Айди лекарства                        | `drugs.id`     |
| starts_at   | `DATE` | Дата начала действия рецепта          |                |
| expires_at  | `DATE` | Дата истечения срока действия рецепта |                |


### orders

Таблица заказов

| Поле            | Тип    | Описание                     | Ссылается на                |
| --------------- | ------ | ---------------------------- | --------------------------- |
| id              | `INT`  |                              |                             |
| customer_id     | `INT`  | Айди клиента                 | `customers.id`              |
| employee_id     | `INT`  | Айди  сотрудника             | `employees.id`              |
| drug_id         | `INT`  | Айди лекарства               | `drugs.id`                  |
| prescription_id | `INT`  | Айди использованного рецепта | `customer_prescriptions.id` |
| date            | `DATE` | Дата заказа                  |                             |


*Я мог бы поддержать возможность иметь несколько лекарств в одном заказе, создав связь many-to-many с помощью таблицы `order_content`, но тогда в процедуре `make_order` мне бы пришлось принимать строковый аргумент `drug_ids` и разбивать его. Проблема в том, что у меня на сервере стоит MariaDB, где, насколько я понял, нет нормальной функции `STRING_SPLIT`.*


## Типовые операции

### Добавление клиента

```sql
INSERT INSERT INTO customers (name, phone, date_of_birth)
VALUES  ('Денисенко Дмитрий', '+79500762499', '1966-12-13');
```

### Изменение данных клиента

```sql
UPDATE customers 
SET `date_of_birth` = '1985-12-13' 
WHERE customers.id = 1;
```

### Добавление рецепта

```sql
INSERT INTO customer_prescriptions (customer_id, drug_id, starts_at, expires_at) 
VALUES (1, 3, '2024-09-13', '2024-12-13');
```

### Оформление заказов

Поскольку оформление заказа — многоступенчатая операция, включающая валидацию рецепта, количества и обновление нескольких таблиц, я вынес её в отдельную процедуру `make_order` с аргументами Клиент, Лекарство, Количество, Сотрудник и Рецепт:

```sql
CALL make_order(3, 3, 2, 1, 1);
```

Если лекарство отпускается без рецепта, последним аргументом передаём NULL:
```sql
CALL make_order(1, 3, 3, 1, NULL);
```

Если рецепт недействителен или отсутствует, лекарства нет в наличии, и при прочих ошибках заказ не будет оформлен. Например:

```sql
CALL make_order(3, 3, 2, 1, NULL);
-- >ERROR 1644 (45000) at line 145: Требуется действующий рецепт
```